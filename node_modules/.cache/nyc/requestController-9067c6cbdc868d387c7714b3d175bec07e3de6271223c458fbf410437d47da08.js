function cov_o1xc52sna(){var path="/home/teja/saiteja/minor_pro/controller/requestController.js";var hash="a1a5627080b5d0729aa319c24b8c167c0d7dfe36";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/home/teja/saiteja/minor_pro/controller/requestController.js",statementMap:{"0":{start:{line:1,column:24},end:{line:1,column:42}},"1":{start:{line:2,column:20},end:{line:2,column:44}},"2":{start:{line:3,column:11},end:{line:3,column:34}},"3":{start:{line:4,column:24},end:{line:4,column:53}},"4":{start:{line:5,column:0},end:{line:5,column:27}},"5":{start:{line:9,column:2},end:{line:55,column:3}},"6":{start:{line:11,column:4},end:{line:11,column:41}},"7":{start:{line:12,column:15},end:{line:12,column:43}},"8":{start:{line:13,column:25},end:{line:13,column:50}},"9":{start:{line:16,column:24},end:{line:16,column:96}},"10":{start:{line:19,column:32},end:{line:19,column:106}},"11":{start:{line:22,column:4},end:{line:24,column:5}},"12":{start:{line:23,column:6},end:{line:23,column:80}},"13":{start:{line:27,column:20},end:{line:30,column:5}},"14":{start:{line:31,column:19},end:{line:31,column:68}},"15":{start:{line:34,column:21},end:{line:40,column:5}},"16":{start:{line:41,column:23},end:{line:41,column:58}},"17":{start:{line:44,column:4},end:{line:44,column:118}},"18":{start:{line:46,column:4},end:{line:46,column:90}},"19":{start:{line:48,column:4},end:{line:48,column:35}},"20":{start:{line:49,column:4},end:{line:49,column:16}},"21":{start:{line:52,column:4},end:{line:54,column:5}},"22":{start:{line:53,column:6},end:{line:53,column:27}},"23":{start:{line:58,column:0},end:{line:58,column:37}}},fnMap:{"0":{name:"registerNewUser",decl:{start:{line:7,column:15},end:{line:7,column:30}},loc:{start:{line:7,column:52},end:{line:56,column:1}},line:7}},branchMap:{"0":{loc:{start:{line:22,column:4},end:{line:24,column:5}},type:"if",locations:[{start:{line:22,column:4},end:{line:24,column:5}},{start:{line:22,column:4},end:{line:24,column:5}}],line:22},"1":{loc:{start:{line:22,column:8},end:{line:22,column:88}},type:"binary-expr",locations:[{start:{line:22,column:8},end:{line:22,column:40}},{start:{line:22,column:44},end:{line:22,column:88}}],line:22},"2":{loc:{start:{line:52,column:4},end:{line:54,column:5}},type:"if",locations:[{start:{line:52,column:4},end:{line:54,column:5}},{start:{line:52,column:4},end:{line:54,column:5}}],line:52}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0},f:{"0":0},b:{"0":[0,0],"1":[0,0],"2":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"a1a5627080b5d0729aa319c24b8c167c0d7dfe36"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];{// @ts-ignore
cov_o1xc52sna=function(){return actualCoverage;};}return actualCoverage;}cov_o1xc52sna();const{MongoClient}=(cov_o1xc52sna().s[0]++,require('mongodb'));const rekognition=(cov_o1xc52sna().s[1]++,require('../config/aws'));const s3=(cov_o1xc52sna().s[2]++,require('../config/s3'));const{mongoClient}=(cov_o1xc52sna().s[3]++,require('../config/database'));cov_o1xc52sna().s[4]++;require('dotenv').config();async function registerNewUser(userData,photoData){cov_o1xc52sna().f[0]++;let client;cov_o1xc52sna().s[5]++;try{cov_o1xc52sna().s[6]++;// Connect to MongoDB
client=await mongoClient.connect();const db=(cov_o1xc52sna().s[7]++,client.db('facerecognition'));const collectionId=(cov_o1xc52sna().s[8]++,process.env.COLLECTION_ID);// Convert the base64-encoded string to a Buffer
const imageBuffer=(cov_o1xc52sna().s[9]++,Buffer.from(photoData.replace(/^data:image\/\w+;base64,/,''),'base64'));// Detect faces in the image
const rekognitionResponse=(cov_o1xc52sna().s[10]++,await rekognition.detectFaces({Image:{Bytes:imageBuffer}}).promise());// Check if exactly one face is detected
cov_o1xc52sna().s[11]++;if((cov_o1xc52sna().b[1][0]++,!rekognitionResponse.FaceDetails)||(cov_o1xc52sna().b[1][1]++,rekognitionResponse.FaceDetails.length!==1)){cov_o1xc52sna().b[0][0]++;cov_o1xc52sna().s[12]++;throw new Error('Exactly 1 face must be detected in the provided image.');}else{cov_o1xc52sna().b[0][1]++;}// Store user data in MongoDB
const newUser=(cov_o1xc52sna().s[13]++,{name:userData,request:'pending'});const result=(cov_o1xc52sna().s[14]++,await db.collection('reg_req').insertOne(newUser));// Upload photo to S3 bucket
const s3Params=(cov_o1xc52sna().s[15]++,{Bucket:'faces-samp',// Bucket name
Key:`detected_faces/${result.insertedId}.jpg`,// Upload to the "detected_faces" folder with ObjectId as filename
Body:imageBuffer,ContentType:'image/png'// Allow public access to the uploaded image
});const s3Response=(cov_o1xc52sna().s[16]++,await s3.upload(s3Params).promise());// Update user data in MongoDB with S3 image URL
cov_o1xc52sna().s[17]++;await db.collection('reg_req').updateOne({_id:result.insertedId},{$set:{imageUrl:s3Response.Location}});cov_o1xc52sna().s[18]++;return{success:true,message:'User registration request submitted successfully'};}catch(error){cov_o1xc52sna().s[19]++;console.error('Error:',error);cov_o1xc52sna().s[20]++;throw error;// Rethrow the error to be caught by the route handler
}finally{cov_o1xc52sna().s[21]++;// Close MongoDB client
if(client){cov_o1xc52sna().b[2][0]++;cov_o1xc52sna().s[22]++;await client.close();}else{cov_o1xc52sna().b[2][1]++;}}}cov_o1xc52sna().s[23]++;module.exports={registerNewUser};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb3ZfbzF4YzUyc25hIiwiYWN0dWFsQ292ZXJhZ2UiLCJNb25nb0NsaWVudCIsInMiLCJyZXF1aXJlIiwicmVrb2duaXRpb24iLCJzMyIsIm1vbmdvQ2xpZW50IiwiY29uZmlnIiwicmVnaXN0ZXJOZXdVc2VyIiwidXNlckRhdGEiLCJwaG90b0RhdGEiLCJmIiwiY2xpZW50IiwiY29ubmVjdCIsImRiIiwiY29sbGVjdGlvbklkIiwicHJvY2VzcyIsImVudiIsIkNPTExFQ1RJT05fSUQiLCJpbWFnZUJ1ZmZlciIsIkJ1ZmZlciIsImZyb20iLCJyZXBsYWNlIiwicmVrb2duaXRpb25SZXNwb25zZSIsImRldGVjdEZhY2VzIiwiSW1hZ2UiLCJCeXRlcyIsInByb21pc2UiLCJiIiwiRmFjZURldGFpbHMiLCJsZW5ndGgiLCJFcnJvciIsIm5ld1VzZXIiLCJuYW1lIiwicmVxdWVzdCIsInJlc3VsdCIsImNvbGxlY3Rpb24iLCJpbnNlcnRPbmUiLCJzM1BhcmFtcyIsIkJ1Y2tldCIsIktleSIsImluc2VydGVkSWQiLCJCb2R5IiwiQ29udGVudFR5cGUiLCJzM1Jlc3BvbnNlIiwidXBsb2FkIiwidXBkYXRlT25lIiwiX2lkIiwiJHNldCIsImltYWdlVXJsIiwiTG9jYXRpb24iLCJzdWNjZXNzIiwibWVzc2FnZSIsImVycm9yIiwiY29uc29sZSIsImNsb3NlIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJzb3VyY2VzIjpbInJlcXVlc3RDb250cm9sbGVyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgTW9uZ29DbGllbnQgfSA9IHJlcXVpcmUoJ21vbmdvZGInKTtcbmNvbnN0IHJla29nbml0aW9uID0gcmVxdWlyZSgnLi4vY29uZmlnL2F3cycpO1xuY29uc3QgczMgPSByZXF1aXJlKCcuLi9jb25maWcvczMnKTtcbmNvbnN0IHsgbW9uZ29DbGllbnQgfSA9IHJlcXVpcmUoJy4uL2NvbmZpZy9kYXRhYmFzZScpO1xucmVxdWlyZSgnZG90ZW52JykuY29uZmlnKCk7XG5cbmFzeW5jIGZ1bmN0aW9uIHJlZ2lzdGVyTmV3VXNlcih1c2VyRGF0YSwgcGhvdG9EYXRhKSB7XG4gIGxldCBjbGllbnQ7XG4gIHRyeSB7XG4gICAgLy8gQ29ubmVjdCB0byBNb25nb0RCXG4gICAgY2xpZW50ID0gYXdhaXQgbW9uZ29DbGllbnQuY29ubmVjdCgpO1xuICAgIGNvbnN0IGRiID0gY2xpZW50LmRiKCdmYWNlcmVjb2duaXRpb24nKTtcbiAgICBjb25zdCBjb2xsZWN0aW9uSWQgPSBwcm9jZXNzLmVudi5DT0xMRUNUSU9OX0lEO1xuXG4gICAgLy8gQ29udmVydCB0aGUgYmFzZTY0LWVuY29kZWQgc3RyaW5nIHRvIGEgQnVmZmVyXG4gICAgY29uc3QgaW1hZ2VCdWZmZXIgPSBCdWZmZXIuZnJvbShwaG90b0RhdGEucmVwbGFjZSgvXmRhdGE6aW1hZ2VcXC9cXHcrO2Jhc2U2NCwvLCAnJyksICdiYXNlNjQnKTtcblxuICAgIC8vIERldGVjdCBmYWNlcyBpbiB0aGUgaW1hZ2VcbiAgICBjb25zdCByZWtvZ25pdGlvblJlc3BvbnNlID0gYXdhaXQgcmVrb2duaXRpb24uZGV0ZWN0RmFjZXMoeyBJbWFnZTogeyBCeXRlczogaW1hZ2VCdWZmZXIgfSB9KS5wcm9taXNlKCk7XG5cbiAgICAvLyBDaGVjayBpZiBleGFjdGx5IG9uZSBmYWNlIGlzIGRldGVjdGVkXG4gICAgaWYgKCFyZWtvZ25pdGlvblJlc3BvbnNlLkZhY2VEZXRhaWxzIHx8IHJla29nbml0aW9uUmVzcG9uc2UuRmFjZURldGFpbHMubGVuZ3RoICE9PSAxKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0V4YWN0bHkgMSBmYWNlIG11c3QgYmUgZGV0ZWN0ZWQgaW4gdGhlIHByb3ZpZGVkIGltYWdlLicpO1xuICAgIH1cblxuICAgIC8vIFN0b3JlIHVzZXIgZGF0YSBpbiBNb25nb0RCXG4gICAgY29uc3QgbmV3VXNlciA9IHtcbiAgICAgIG5hbWU6IHVzZXJEYXRhLFxuICAgICAgcmVxdWVzdDogJ3BlbmRpbmcnXG4gICAgfTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBkYi5jb2xsZWN0aW9uKCdyZWdfcmVxJykuaW5zZXJ0T25lKG5ld1VzZXIpO1xuXG4gICAgLy8gVXBsb2FkIHBob3RvIHRvIFMzIGJ1Y2tldFxuICAgIGNvbnN0IHMzUGFyYW1zID0ge1xuICAgICAgQnVja2V0OiAnZmFjZXMtc2FtcCcsIC8vIEJ1Y2tldCBuYW1lXG4gICAgICBLZXk6IGBkZXRlY3RlZF9mYWNlcy8ke3Jlc3VsdC5pbnNlcnRlZElkfS5qcGdgLCAvLyBVcGxvYWQgdG8gdGhlIFwiZGV0ZWN0ZWRfZmFjZXNcIiBmb2xkZXIgd2l0aCBPYmplY3RJZCBhcyBmaWxlbmFtZVxuICAgICAgQm9keTogaW1hZ2VCdWZmZXIsXG4gICAgICBDb250ZW50VHlwZTogJ2ltYWdlL3BuZycsXG4gICAgIC8vIEFsbG93IHB1YmxpYyBhY2Nlc3MgdG8gdGhlIHVwbG9hZGVkIGltYWdlXG4gICAgfTtcbiAgICBjb25zdCBzM1Jlc3BvbnNlID0gYXdhaXQgczMudXBsb2FkKHMzUGFyYW1zKS5wcm9taXNlKCk7XG5cbiAgICAvLyBVcGRhdGUgdXNlciBkYXRhIGluIE1vbmdvREIgd2l0aCBTMyBpbWFnZSBVUkxcbiAgICBhd2FpdCBkYi5jb2xsZWN0aW9uKCdyZWdfcmVxJykudXBkYXRlT25lKHsgX2lkOiByZXN1bHQuaW5zZXJ0ZWRJZCB9LCB7ICRzZXQ6IHsgaW1hZ2VVcmw6IHMzUmVzcG9uc2UuTG9jYXRpb24gfSB9KTtcblxuICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIG1lc3NhZ2U6ICdVc2VyIHJlZ2lzdHJhdGlvbiByZXF1ZXN0IHN1Ym1pdHRlZCBzdWNjZXNzZnVsbHknIH07XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignRXJyb3I6JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yOyAvLyBSZXRocm93IHRoZSBlcnJvciB0byBiZSBjYXVnaHQgYnkgdGhlIHJvdXRlIGhhbmRsZXJcbiAgfSBmaW5hbGx5IHtcbiAgICAvLyBDbG9zZSBNb25nb0RCIGNsaWVudFxuICAgIGlmIChjbGllbnQpIHtcbiAgICAgIGF3YWl0IGNsaWVudC5jbG9zZSgpO1xuICAgIH1cbiAgfVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHsgcmVnaXN0ZXJOZXdVc2VyIH07XG4iXSwibWFwcGluZ3MiOiIreUZBZVk7QUFBQUEsYUFBQSxTQUFBQSxDQUFBLFNBQUFDLGNBQUEsV0FBQUEsY0FBQSxFQUFBRCxhQUFBLEdBZlosS0FBTSxDQUFFRSxXQUFZLENBQUMsRUFBQUYsYUFBQSxHQUFBRyxDQUFBLE1BQUdDLE9BQU8sQ0FBQyxTQUFTLENBQUMsRUFDMUMsS0FBTSxDQUFBQyxXQUFXLEVBQUFMLGFBQUEsR0FBQUcsQ0FBQSxNQUFHQyxPQUFPLENBQUMsZUFBZSxDQUFDLEVBQzVDLEtBQU0sQ0FBQUUsRUFBRSxFQUFBTixhQUFBLEdBQUFHLENBQUEsTUFBR0MsT0FBTyxDQUFDLGNBQWMsQ0FBQyxFQUNsQyxLQUFNLENBQUVHLFdBQVksQ0FBQyxFQUFBUCxhQUFBLEdBQUFHLENBQUEsTUFBR0MsT0FBTyxDQUFDLG9CQUFvQixDQUFDLEVBQUNKLGFBQUEsR0FBQUcsQ0FBQSxNQUN0REMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDSSxNQUFNLENBQUMsQ0FBQyxDQUUxQixjQUFlLENBQUFDLGVBQWVBLENBQUNDLFFBQVEsQ0FBRUMsU0FBUyxDQUFFLENBQUFYLGFBQUEsR0FBQVksQ0FBQSxNQUNsRCxHQUFJLENBQUFDLE1BQU0sQ0FBQ2IsYUFBQSxHQUFBRyxDQUFBLE1BQ1gsR0FBSSxDQUFBSCxhQUFBLEdBQUFHLENBQUEsTUFDRjtBQUNBVSxNQUFNLENBQUcsS0FBTSxDQUFBTixXQUFXLENBQUNPLE9BQU8sQ0FBQyxDQUFDLENBQ3BDLEtBQU0sQ0FBQUMsRUFBRSxFQUFBZixhQUFBLEdBQUFHLENBQUEsTUFBR1UsTUFBTSxDQUFDRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFDdkMsS0FBTSxDQUFBQyxZQUFZLEVBQUFoQixhQUFBLEdBQUFHLENBQUEs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